5.1 編譯16MB Flash專用的OpenWRT firmware

＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊
參考資料：
http://wiki.openwrt.org/zh-tw/doc/howto/build#清除
http://coderazzi.net/howto/openwrt/tl841n/install.htm
http://m.oschina.net/blog/282141
http://my.oschina.net/osbin/blog/278782

＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊
編譯環境：運行X86_64版本的Linux Mint 17，筆記型電腦
anntony-Lenovo-B590 ~ # uname -a
Linux anntony-Lenovo-B590 3.13.0-24-generic #47-Ubuntu SMP Fri May 2 23:30:00 UTC 2014 x86_64 x86_64 x86_64 GNU/Linux

＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊
工作列表：
     5.1.1 使用svn拉下trunk分支的OpenWRT源代碼
     5.1.2 看一下trunk/README 寫什麼
     5.1.3 確認編譯固件所需的依賴套件是否全裝上了？
     5.1.4 更新feeds
     5.1.5 修改源代碼以符合我們16MB Flash固件需求
          5.1.5.1 修改~/openwrt/trunk/target/linux/ar71xx/base-files/etc/uci-defaults/01_leds
          5.1.5.2 修改~/openwrt/trunk/target/linux/ar71xx/base-files/etc/uci-defaults/02_network
          5.1.5.3 修改~/openwrt/trunk/target/linux/ar71xx/image/Makefile
          5.1.5.4 修改~/openwrt/trunk/tools/firmware-utils/src/mktplinkfw.c
     5.1.6 修改固件預設的環境配置
          5.1.6.1 預設的Lan IP
          5.1.6.2 預設的無線網路配置
          5.1.6.3 預設的主機名、時區、ntp校時服務器
          5.1.6.4 預設的語言環境
     5.1.7 進入make menuconfig 設定畫面
     5.1.8 開始編譯
     5.1.9 編譯好的影像檔在那兒？

＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊
細節：
＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊
5.1.1 使用svn拉下trunk分支的OpenWRT源代碼

確認一下你已經安裝好svn了
$ which svn

已經安裝好的話，就會看到終端機回答
/usr/bin/svn

如果沒有安裝，請切換到root用戶，安裝
$ sudo -i
# apt-get install subversion

待會的動作都是用一般用戶的身分執行，問一下終端機我是誰？
$ whoami

終端機說我是
anntony

切換到我的家目錄/home/anntony
$ cd /home/anntony

新增一個openwrt目錄
$ mkdir openwrt

進入該目錄
$ cd openwrt

問卦一下我人現在在那裡？
$ pwd

終端機告訴我
/home/anntony/openwrt

接著在這個目錄裡，把openwrt的源代碼拉下來
先看一下OpenWRT官方的GetSource的網頁
https://dev.openwrt.org/wiki/GetSource

有很多版本，有trunk、有14.07 Barrier Breaker、有12.09 Attitude Adjustment
我們去拉主要的開發分支trunk，執行
$ svn co svn://svn.openwrt.org/openwrt/trunk/

然後耐心等一下，終端機會輸出很多下載了什麼檔案的訊息
（終端機超長的輸出訊息省略…）
A    trunk/config/Config-kernel.in
A    trunk/BSDmakefile
A    trunk/.gitattributes
A    trunk/Config.in
A    trunk/Makefile
 U   trunk
取出修訂版 43853.

終端機輸出的訊息很長，所以我只放上最後幾行
最後一行很重要，它告訴我們取出來修訂版是43853
svn我根本不熟，這裡的修訂版43853我想應該和git的commit是同樣的東西吧？

剛才的svn指令成功的在/home/anntony/openwrt目錄裡，拉下了trunk目錄

＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊
5.1.2 看一下trunk/README 寫什麼

原諒我這個懶鬼
anntony@anntony-Lenovo-B590 ~/openwrt $ pwd
/home/anntony/openwrt
anntony@anntony-Lenovo-B590 ~/openwrt $ ls
trunk
anntony@anntony-Lenovo-B590 ~/openwrt $ cd trunk
anntony@anntony-Lenovo-B590 ~/openwrt/trunk $ ls
BSDmakefile  config  Config.in  docs  feeds.conf.default  include  LICENSE  Makefile  package  README  rules.mk  scripts  target  toolchain  tools
anntony@anntony-Lenovo-B590 ~/openwrt/trunk $ cat ./README 
This is the buildsystem for the OpenWrt Linux distribution.

Please use "make menuconfig" to configure your appreciated
configuration for the toolchain and firmware.

You need to have installed gcc, binutils, bzip2, flex, python, perl, make,
find, grep, diff, unzip, gawk, getopt, subversion, libz-dev and libc headers.

Run "./scripts/feeds update -a" to get all the latest package definitions
defined in feeds.conf / feeds.conf.default respectively
and "./scripts/feeds install -a" to install symlinks of all of them into
package/feeds/.

Use "make menuconfig" to configure your image.

Simply running "make" will build your firmware.
It will download all sources, build the cross-compile toolchain, 
the kernel and all choosen applications.

You can use "scripts/flashing/flash.sh" for remotely updating your embedded
system via tftp.

The OpenWrt system is documented in docs/. You will need a LaTeX distribution
and the tex4ht package to build the documentation. Type "make -C docs/" to build it.

To build your own firmware you need to have access to a Linux, BSD or MacOSX system
(case-sensitive filesystem required). Cygwin will not be supported because of
the lack of case sensitiveness in the file system.


Sunshine!
	Your OpenWrt Project
	http://openwrt.org


anntony@anntony-Lenovo-B590 ~/openwrt/trunk $

＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊
5.1.3 確認編譯固件所需的依賴套件是否全裝上了？

上面的README裡寫著
You need to have installed gcc, binutils, bzip2, flex, python, perl, make,
find, grep, diff, unzip, gawk, getopt, subversion, libz-dev and libc headers.

所以打開Synaptic套件管理員
一個一個把它們裝上去
如果不小心漏了也沒關係
之後的步驟裡如果發現編譯平台上少安裝了什麼套件或是lib
會發出警告訊息，明確告訴你少安裝了什麼套件

＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊
 5.1.4 更新feeds

anntony@anntony-Lenovo-B590 ~/openwrt/trunk $ pwd
/home/anntony/openwrt/trunk
anntony@anntony-Lenovo-B590 ~/openwrt/trunk $ ls
BSDmakefile  config  Config.in  docs  feeds.conf.default  include  LICENSE  Makefile  package  README  rules.mk  scripts  target  toolchain  tools
anntony@anntony-Lenovo-B590 ~/openwrt/trunk $ ./scripts/feeds update -a
（終端機輸出很長，不放上，大致上是執行git去拉一些放在github上的依賴套件的源碼repo）
anntony@anntony-Lenovo-B590 ~/openwrt/trunk $ ./scripts/feeds install -a
（一樣終端機輸出很長，不放上）

我有點在意的是，在執行了上面的指令
$ ./scripts/feeds install -a
之後
出現了很多的WARNING訊息，像是
WARNING: No feed for package 'libcrypto' found, maybe it's already part of the standard packages?
WARNING: No feed for package 'kmod-siit' found, maybe it's already part of the standard packages?
WARNING: No feed for package 'smap' found, maybe it's already part of the standard packages?
WARNING: No feed for package 'netdiscover' found, maybe it's already part of the standard packages?
WARNING: No feed for package 'mac-to-devinfo' found, maybe it's already part of the standard packages?
WARNING: No feed for package 'httping' found, maybe it's already part of the standard packages?
WARNING: No feed for package 'smap-to-devinfo' found, maybe it's already part of the standard packages?
WARNING: No feed for package 'netdiscover-to-devinfo' found, maybe it's already part of the standard packages?

一狗串，可是最後幾行的地方終端機輸出的訊息像這樣
Installing package 'freenetconfd'
Installing package 'libssh'
Installing package 'freesub'
Installing package 'libev'
Installing package 'libnetconf'
Installing package 'shtool'
anntony@anntony-Lenovo-B590 ~/openwrt/trunk $

感覺好像沒關係，繼續弄下去就知道了
如果真的有問題，那麼要不是沒辦法編譯出
openwrt-ar71xx-generic-tl-wr841n-v8-squashfs-factory.bin
要不就是編譯出來的影像檔，燒進ROM裡有問題
繼續弄下去好了，這不是ERROR而是WARNING，雖然看了不是很舒服

搜尋關鍵字：
openwrt WARNING: No feed for package

參考資料：
https://dev.openwrt.org.cn/wiki/installfeeds

＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊
5.1.5 修改源代碼以符合我們16MB Flash固件需求
＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊
5.1.5.1 修改~/openwrt/trunk/target/linux/ar71xx/base-files/etc/uci-defaults/01_leds

看了很多前輩的文章，改這個檔案是為了讓路由器的燈號順序正常
開啟vi文字編輯器
$ vi ~/openwrt/trunk/target/linux/ar71xx/base-files/etc/uci-defaults/01_leds

找到檔案裡的原來這個區塊
tl-wr841n-v8)
        ucidef_set_led_netdev "wan" "WAN" "tp-link:green:wan" "eth0"
        ucidef_set_led_switch "lan1" "LAN1" "tp-link:green:lan1" "switch0" "0x04"
        ucidef_set_led_switch "lan2" "LAN2" "tp-link:green:lan2" "switch0" "0x08"
        ucidef_set_led_switch "lan3" "LAN3" "tp-link:green:lan3" "switch0" "0x10"
        ucidef_set_led_switch "lan4" "LAN4" "tp-link:green:lan4" "switch0" "0x02"
        ucidef_set_led_wlan "wlan" "WLAN" "tp-link:green:wlan" "phy0tpt"
        ;;

請把它改成這樣
tl-wr841n-v8)
        ucidef_set_led_netdev "wan" "WAN" "tp-link:green:wan" "eth0"
        ucidef_set_led_switch "lan1" "LAN1" "tp-link:green:lan1" "switch0" "0x02"
        ucidef_set_led_switch "lan2" "LAN2" "tp-link:green:lan2" "switch0" "0x04"
        ucidef_set_led_switch "lan3" "LAN3" "tp-link:green:lan3" "switch0" "0x08"
        ucidef_set_led_switch "lan4" "LAN4" "tp-link:green:lan4" "switch0" "0x10"
        ucidef_set_led_wlan "wlan" "WLAN" "tp-link:green:wlan" "phy0tpt"
        ;;

＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊
 5.1.5.2 修改~/openwrt/trunk/target/linux/ar71xx/files/arch/mips/ath79/mach-tl-wr841n-v8.c

不幸的是，除了路由器的燈號，連每個網路接口的順序都是錯亂的
正常的情況下應該是WAN-LAN-LAN-LAN-LAN
開啟vi文字編輯器
$ vi ~/openwrt/trunk/target/linux/ar71xx/files/arch/mips/ath79/mach-tl-wr841n-v8.c

找到檔案裡的原來這個區塊
這個叫作tl_ap123_setup的函式，我不想重複貼兩次，這個是已經改好的
有改的那三行我在後面加了中文注釋

static void __init tl_ap123_setup(void)
{
        u8 *mac = (u8 *) KSEG1ADDR(0x1f01fc00);
        u8 *ee = (u8 *) KSEG1ADDR(0x1fff1000);

        /* Disable JTAG, enabling GPIOs 0-3 */
        /* Configure OBS4 line, for GPIO 4*/
        ath79_gpio_function_setup(AR934X_GPIO_FUNC_JTAG_DISABLE,
                                 AR934X_GPIO_FUNC_CLK_OBS4_EN);

        /* config gpio4 as normal gpio function */
        ath79_gpio_output_select(TL_MR3420V2_GPIO_USB_POWER,
                                 AR934X_GPIO_OUT_GPIO);

        ath79_register_m25p80(&tl_wr841n_v8_flash_data);

        ath79_setup_ar934x_eth_cfg(AR934X_ETH_CFG_SW_ONLY_MODE); //原本的是 ath79_setup_ar934x_eth_cfg(AR934X_ETH_CFG_SW_PHY_SWAP);

        ath79_register_mdio(1, 0x0);

        ath79_init_mac(ath79_eth0_data.mac_addr, mac, -1);
        ath79_init_mac(ath79_eth1_data.mac_addr, mac, 0);

        /* GMAC0 is connected to the PHY0 of the internal switch */
        ath79_switch_data.phy4_mii_en = 1;
        ath79_switch_data.phy_poll_mask = BIT(4); //原本的是 ath79_switch_data.phy_poll_mask = BIT(0);
        ath79_eth0_data.phy_if_mode = PHY_INTERFACE_MODE_MII;
        ath79_eth0_data.phy_mask = BIT(4);  //原本的是 ath79_eth0_data.phy_mask = BIT(0);
        ath79_eth0_data.mii_bus_dev = &ath79_mdio1_device.dev;
        ath79_register_eth(0);

        /* GMAC1 is connected to the internal switch */
        ath79_eth1_data.phy_if_mode = PHY_INTERFACE_MODE_GMII;
        ath79_register_eth(1);

        ath79_register_wmac(ee, mac);
}

不只是TL-WR841N/D，只要SoC是AR9341的路由器，
刷上了OpenWRT都會有燈號或是WAN-LAN接口錯置的問題
Google關鍵字：
ar9341 網口 修正
ar9341 wan lan lan

參考資料：
http://www.right.com.cn/forum/thread-121913-2-1.html

這個網友有另一個修改方式
https://github.com/qianguozheng/qsdk/commit/11c4ee98ae56a425b35082a15bdd6a1ddb341487
但是中文論壇上有其他網友回報說，照著改的話，PPPoe的功能會失去作用，所以我沒採用，但可以參考

＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊
5.1.5.3 修改~/openwrt/trunk/target/linux/ar71xx/image/Makefile

開啟vi文字編輯器
$ vi ~/openwrt/trunk/target/linux/ar71xx/image/Makefile

找到原來的這一行
$(eval $(call SingleProfile,TPLINK-LZMA,64kraw,TLWR841NV8,tl-wr841n-v8,TL-WR841N-v8,ttyS0,115200,0x08410008,1,4Mlzma))
改成這樣
$(eval $(call SingleProfile,TPLINK-LZMA,64kraw,TLWR841NV8,tl-wr841n-v8,TL-WR841N-v8,ttyS0,115200,0x08410008,1,16Mlzma))

＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊
5.1.5.4 修改~/openwrt/trunk/tools/firmware-utils/src/mktplinkfw.c

原來的檔案裡沒有TL_WR841ND_V8的定義
開啟vi文字編輯器
$ vi ~/openwrt/trunk/tools/firmware-utils/src/mktplinkfw.c

找到這個區塊
#define HWID_TL_WR841N_V1_5     0x08410002
#define HWID_TL_WR841ND_V3      0x08410003
#define HWID_TL_WR841ND_V5      0x08410005
#define HWID_TL_WR841ND_V7      0x08410007
#define HWID_TL_WR941ND_V2      0x09410002

在中間插入一行，變成這樣
#define HWID_TL_WR841N_V1_5     0x08410002
#define HWID_TL_WR841ND_V3      0x08410003
#define HWID_TL_WR841ND_V5      0x08410005
#define HWID_TL_WR841ND_V7      0x08410007
#define HWID_TL_WR841ND_V8      0x08410008
#define HWID_TL_WR941ND_V2      0x09410002

再找到這個區塊
        }, {
                .id             = "16M",
                .fw_max_len     = 0xf80000,
                .kernel_la      = 0x80060000,
                .kernel_ep      = 0x80060000,
                .rootfs_ofs     = 0x140000,
        }, {
                .id             = "16Mlzma",
                .fw_max_len     = 0xf80000,
                .kernel_la      = 0x80060000,
                .kernel_ep      = 0x80060000,
                .rootfs_ofs     = 0x100000,
        }, {
                .id             = "16Mppc",
                .fw_max_len     = 0xf80000,
                .kernel_la      = 0x00000000,
                .kernel_ep      = 0xc0000000,
                .rootfs_ofs     = 0x2a0000,
        }, {
                /* terminating entry */
        }
};

把和16M有關係的.fw_max_len都改了，改成這樣
       }, {
                .id             = "16M",
                .fw_max_len     = 0xfc0000,
                .kernel_la      = 0x80060000,
                .kernel_ep      = 0x80060000,
                .rootfs_ofs     = 0x140000,
        }, {
                .id             = "16Mlzma",
                .fw_max_len     = 0xfc0000,
                .kernel_la      = 0x80060000,
                .kernel_ep      = 0x80060000,
                .rootfs_ofs     = 0x100000,
        }, {
                .id             = "16Mppc",
                .fw_max_len     = 0xfc0000,
                .kernel_la      = 0x00000000,
                .kernel_ep      = 0xc0000000,
                .rootfs_ofs     = 0x2a0000,
        }, {
                /* terminating entry */
        }
};

然後再找到這個區塊
        }, {
                .id             = "TL-WR841NDv5",
                .hw_id          = HWID_TL_WR841ND_V5,
                .hw_rev         = 1,
                .layout_id      = "4M",
        }, {
                .id             = "TL-WR841NDv7",
                .hw_id          = HWID_TL_WR841ND_V7,
                .hw_rev         = 1,
                .layout_id      = "4M",
        }, {
                .id             = "TL-WR941NDv2",
                .hw_id          = HWID_TL_WR941ND_V2,
                .hw_rev         = 2,
                .layout_id      = "4M",
        }, {

在TL-WR941NDv2前面插入一個TL-WR841NDv8的區塊，變成這個樣子
        }, {
                .id             = "TL-WR841NDv5",
                .hw_id          = HWID_TL_WR841ND_V5,
                .hw_rev         = 1,
                .layout_id      = "4M",
        }, {
                .id             = "TL-WR841NDv7",
                .hw_id          = HWID_TL_WR841ND_V7,
                .hw_rev         = 1,
                .layout_id      = "4M",
        }, {
                .id             = "TL-WR841NDv8",
                .hw_id          = HWID_TL_WR841ND_V8,
                .hw_rev         = 1,
                .layout_id      = "16Mlzma",
        }, {
                .id             = "TL-WR941NDv2",
                .hw_id          = HWID_TL_WR941ND_V2,
                .hw_rev         = 2,
                .layout_id      = "4M",
        }, {

＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊
5.1.6 修改固件預設的環境配置
＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊
5.1.6.1 預設的Lan IP

$ vi ~/openwrt/trunk/package/base-files/files/lib/functions/uci-defaults.sh

找到這一行
set network.lan.ipaddr='192.168.1.1'

預設的Lan IP就很合用，我不想改，如果你要改就是改這裡

＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊
5.1.6.2 預設的無線網路配置

我希望wifi的功能預設是開啟的
ssid叫作OpenWrt_kashu
使用psk2加密
連線密碼是12345678

參考資料：
http://my.oschina.net/osbin/blog/278782
http://wiki.openwrt.org/doc/uci/wireless#wpamodes

打開vi文字編輯器修改檔案
$ vi ~/openwrt/trunk/package/kernel/mac80211/files/lib/wifi/mac80211.sh

把原來的這個地方
        # REMOVE THIS LINE TO ENABLE WIFI:
        option disabled 1

config wifi-iface
        option device   radio$devidx
        option network  lan
        option mode     ap
        option ssid     OpenWrt
        option encryption none

改成這樣
        # REMOVE THIS LINE TO ENABLE WIFI:
        # option disabled 1

config wifi-iface
        option device   radio$devidx
        option network  lan
        option mode     ap
        option ssid     OpenWrt_kashu
        option encryption psk2
        option key 12345678

＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊
5.1.6.3 預設的主機名、時區、ntp校時服務器

參考資料：
http://wiki.openwrt.org/doc/uci/system
http://my.oschina.net/osbin/blog/278782

我希望預設的路由器主機名叫作wr841n
時區是Asia/Taipei
ntp校時服務器換成我們比較近的台灣的服務器

打開vi文字編輯器修改檔案
$ vi ~/openwrt/trunk/package/base-files/files/etc/config/system

原來的檔案內容長這樣
config system
        option hostname OpenWrt
        option timezone UTC

config timeserver ntp
        list server     0.openwrt.pool.ntp.org
        list server     1.openwrt.pool.ntp.org
        list server     2.openwrt.pool.ntp.org
        list server     3.openwrt.pool.ntp.org
        option enabled 1
        option enable_server 0

把它改成這樣
config system
        option hostname wr841n
        option zonename Asia/Taipei
        option timezone CST-8

config timeserver ntp
        list server     0.asia.pool.ntp.org
        list server     1.asia.pool.ntp.org
        list server     2.asia.pool.ntp.org
        list server     3.asia.pool.ntp.org
        option enable_server 0

＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊
5.1.6.4 預設的語言環境

打開vi文字編輯器修改檔案
$ vi ~/openwrt/trunk/feeds/luci/modules/base/root/etc/config/luci

原來的檔案是
config core main
        option lang auto
        option mediaurlbase /luci-static/openwrt.org
        option resourcebase /luci-static/resources

config extern flash_keep
        option uci              "/etc/config/"
        option dropbear "/etc/dropbear/"
        option openvpn  "/etc/openvpn/"
        option passwd   "/etc/passwd"
        option opkg             "/etc/opkg.conf"
        option firewall "/etc/firewall.user"
        option uploads  "/lib/uci/upload/"

config internal languages

config internal sauth
        option sessionpath "/tmp/luci-sessions"
        option sessiontime 3600

config internal ccache
        option enable 1

config internal themes

改成這樣
config core main
        option lang en
        option mediaurlbase /luci-static/openwrt.org
        option resourcebase /luci-static/resources

config extern flash_keep
        option uci              "/etc/config/"
        option dropbear "/etc/dropbear/"
        option openvpn  "/etc/openvpn/"
        option passwd   "/etc/passwd"
        option opkg             "/etc/opkg.conf"
        option firewall "/etc/firewall.user"
        option uploads  "/lib/uci/upload/"

config internal languages
        option en "English"
        option zh_tw "Chinese"

config internal sauth
        option sessionpath "/tmp/luci-sessions"
        option sessiontime 3600

config internal ccache
        option enable 1

config internal themes

＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊
5.1.7 進入make menuconfig 設定畫面

參考資料：
http://my.oschina.net/osbin/blog/278782
https://forum.openwrt.org/viewtopic.php?pid=140470#p140470
http://coderazzi.net/howto/openwrt/tl841n/install.htm

我發現少裝了一個依賴套件，先裝上它
$ sudo apt-get install libssl-dev

然後就
$ cd ~/openwrt/trunk
$ make clean

接著我居然就進入了OpenWrt Configuration的藍底GUI操作選單
我還沒跑make menuconfig就進來了
選定一個target，這個意思是我們要選擇要編譯出的影像檔是給那一台路由器用的
這裡當然是選擇
Target System (Atheros AR7xxx/AR9xxx)  --->Atheros AR7xxx/AR9xxx
還有
Target Profile (Default Profile (all drivers))  --->TP-LINK TL-WR841N/ND

然後先離開一下，選Exit
Do you wish to save your new configuration ? 
選< Yes >離開

使用預設的選項
$ make defconfig

再次叫出藍底GUI操作選單
$ make menuconfig

然後又回到了藍底GUI操作選單
我是這樣選擇的

依晶片分類的Target System及路由器型號 (剛才已經選好了)
Target System (Atheros AR7xxx/AR9xxx)  --->   (X) Atheros AR7xxx/AR9xxx
Target Profile (TP-LINK TL-WR841N/ND)  --->TP-LINK TL-WR841N/ND

Toolchain選起來
 [*] Package the OpenWrt-based Toolchain    

基本上保持原樣，不過加選了一個
Base system  ---> wireless-tools

語言支持
Kernel modules  --->Native Language Support  --->kmod-nls-utf8

USB支持 (只列出我加選的)
Kernel modules  --->USB Support  --->kmod-usb-serial   --->kmod-usb-serial-cp210x

SSH的功能，全選上
Network  --->SSH  --->
Network  --->SSH  --->openssh-client
Network  --->SSH  --->openssh-client-utils
Network  --->SSH  --->openssh-keygen
Network  --->SSH  --->openssh-moduli
Network  --->SSH  --->openssh-server
Network  --->SSH  --->openssh-server-pam
Network  --->SSH  --->openssh-sftp-avahi-service
Network  --->SSH  --->openssh-sftp-client
Network  --->SSH  --->openssh-sftp-server
Network  --->SSH  --->sshtunnel

NTP的功能，除了ntp server其他都選上
Network  --->Time Synchronization  --->ntp-keygen
Network  --->Time Synchronization  --->ntp-utils
Network  --->Time Synchronization  --->ntpclient
Network  --->Time Synchronization  --->ntpdate

關於openvpn-openssl的全都選上
Network  --->VPN  --->openvpn-openssl   --->
Network  --->VPN  --->openvpn-openssl   --->Enable LZO compression support (NEW) 
Network  --->VPN  --->openvpn-openssl   --->Enable the --x509-username-field feature
（下面還有大概十幾個…全選上）

luci網頁操作GUI介面
LuCI  --->Collections  --->luci
LuCI  --->Collections  --->luci-ssl
LuCI  --->Applications  --->luci-app-ddns
LuCI  --->Applications  --->luci-app-diag-core
LuCI  --->Applications  --->luci-app-diag-devinfo
LuCI  --->Applications  --->luci-app-multiwan
LuCI  --->Applications  --->luci-app-ntpc
LuCI  --->Applications  --->luci-app-qos
LuCI  --->Applications  --->luci-app-statistics
LuCI  --->Themes  --->luci-theme-openwrt
LuCI  --->Libraries  --->TLS Provider (Disabled)  --->OpenSSL
LuCI  --->Libraries  --->luci-lib-px5g
LuCI  --->Translations  --->luci-i18n-chinese
LuCI  --->Translations  --->luci-i18n-english
LuCI  --->Applications  --->

全都選好了，就選< Exit >退出藍底GUI操作選單
Do you wish to save your new configuration ? 
選< Yes >儲存剛才選得半死的設定值
設定值會存在
~/openwrt/trunk/.config

回到了終端機，開始編譯了
$ cd ~/openwrt/trunk
$ make V=s

記得保持網路有連線的狀態，因為編譯期間會從網路上抓一些檔案下來
然後就是等等等

＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊
/home/anntony/openwrt/trunk/scripts/download.pl "/home/anntony/openwrt/trunk/dl" "gengetopt-2.22.6.tar.gz" "29749a48dda69277ab969c510597a14e" "@GNU/gengetopt


＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊
install -d -m0755 /home/anntony/openwrt/trunk/build_dir/target-mips_34kc_uClibc-0.9.33.2/ntp-4.2.8/ipkg-ar71xx/ntpdate/usr/sbin
install -m0755 /home/anntony/openwrt/trunk/build_dir/target-mips_34kc_uClibc-0.9.33.2/ntp-4.2.8/ntpdate/ntpdate /home/anntony/openwrt/trunk/build_dir/target-mips_34kc_uClibc-0.9.33.2/ntp-4.2.8/ipkg-ar71xx/ntpdate/usr/sbin/
install -d -m0755 /home/anntony/openwrt/trunk/build_dir/target-mips_34kc_uClibc-0.9.33.2/ntp-4.2.8/ipkg-ar71xx/ntpdate/etc/init.d
install -m0755 ./files/ntpdate.init /home/anntony/openwrt/trunk/build_dir/target-mips_34kc_uClibc-0.9.33.2/ntp-4.2.8/ipkg-ar71xx/ntpdate/etc/init.d/ntpdate
find /home/anntony/openwrt/trunk/build_dir/target-mips_34kc_uClibc-0.9.33.2/ntp-4.2.8/ipkg-ar71xx/ntpdate -name 'CVS' -o -name '.svn' -o -name '.#*' -o -name '*~'| xargs -r rm -rf
Package ntpdate is missing dependencies for the following libraries:
libcrypto.so.1.0.0
libpthread.so.0
make[3]: *** [/home/anntony/openwrt/trunk/bin/ar71xx/packages/packages/ntpdate_4.2.8-1_ar71xx.ipk] Error 1
make[3]: Leaving directory `/home/anntony/openwrt/trunk/feeds/packages/net/ntpd'
make[2]: *** [package/feeds/packages/ntpd/compile] Error 2
make[2]: Leaving directory `/home/anntony/openwrt/trunk'
make[1]: *** [/home/anntony/openwrt/trunk/staging_dir/target-mips_34kc_uClibc-0.9.33.2/stamp/.package_compile] Error 2
make[1]: Leaving directory `/home/anntony/openwrt/trunk'
make: *** [world] Error 2

我的Linux Mint 17已經安裝了libssl1.0.0套件
居然放在這裡
/lib/x86_64-linux-gnu/libcrypto.so.1.0.0

還有libpthread.so.0
anntony@anntony-Lenovo-B590 /lib/x86_64-linux-gnu $ ls -al|grep thr
-rwxr-xr-x  1 root root  141574 12月  2 03:45 libpthread-2.19.so
lrwxrwxrwx  1 root root      18 12月  2 03:44 libpthread.so.0 -> libpthread-2.19.so
-rw-r--r--  1 root root   35640 12月  2 03:45 libthread_db-1.0.so
lrwxrwxrwx  1 root root      19 12月  2 03:44 libthread_db.so.1 -> libthread_db-1.0.so

所以我必須
sudo ln -s /lib/x86_64-linux-gnu/libcrypto.so.1.0.0 /lib/libcrypto.so.1.0.0
sudo ln -s /lib/x86_64-linux-gnu/libcrypto.so.1.0.0 /usr/lib/libcrypto.so.1.0.0

sudo ln -s /lib/x86_64-linux-gnu/libpthread-2.19.so /lib/libpthread.so.0
sudo ln -s /lib/x86_64-linux-gnu/libpthread-2.19.so /usr/lib/libpthread.so.0

第二次編譯還是不行
一樣死在這個地方
搜尋關鍵字
openwrt Package ntpdate is missing dependencies libcrypto.so.1.0.0 libpthread.so.0
找到了參考資料
討論頁
https://github.com/openwrt/packages/pull/747

代碼修正歷史
https://github.com/thess/OpenWrt-packages/commit/50b5fe2e46c82987594dda3d4e206cd184826a43
下載這個新的Makefile
原生格式
https://raw.githubusercontent.com/thess/OpenWrt-packages/50b5fe2e46c82987594dda3d4e206cd184826a43/net/ntpd/Makefile
放在
~/openwrt/trunk/feeds/packages/net/ntpd
這個目錄裡，置換掉舊的Makefile

這裡給出新的改好的正常的Makefile
如下
#
# Copyright (C) 2006-2015 OpenWrt.org
#
# This is free software, licensed under the GNU General Public License v2.
# See /LICENSE for more information.
#

include $(TOPDIR)/rules.mk

PKG_NAME:=ntp
PKG_VERSION:=4.2.8
PKG_RELEASE:=2

PKG_SOURCE:=$(PKG_NAME)-$(PKG_VERSION).tar.gz
PKG_SOURCE_URL:=http://www.eecis.udel.edu/~ntp/ntp_spool/ntp4/ntp-4.2/
PKG_MD5SUM:=6972a626be6150db8cfbd0b63d8719e7

PKG_LICENSE:=Unique
PKG_LICENSE_FILES:=COPYRIGHT html/copyright.html

PKG_BUILD_DIR:=$(BUILD_DIR)/$(PKG_NAME)-$(PKG_VERSION)

PKG_FIXUP:=autoreconf
PKG_LIBTOOL_PATHS:=. sntp
PKG_CHECK_FORMAT_SECURITY:=0

include $(INCLUDE_DIR)/package.mk

define Package/ntpd/Default
  SUBMENU:=Time Synchronization
  SECTION:=net
  CATEGORY:=Network
  TITLE:=ISC ntp
  MAINTAINER:=Peter Wagner <tripolar@gmx.at>
  URL:=http://www.ntp.org/
  DEPENDS:=+libcap
endef

define Package/ntpd/Default/description
 The ISC ntp suite is a collection of tools used to synchronize the
 system clock with remote NTP time servers and run/monitor local NTP
 servers.
endef

define Package/ntpd
$(call Package/ntpd/Default)
  TITLE+= server
  DEPENDS+= +libopenssl +libpthread
  USERID:=ntp=123:ntp=123
endef

define Package/ntpd/description
$(call Package/ntpd/Default/description)
 .
 This package contains the ntpd server.
endef

define Package/ntpdate
$(call Package/ntpd/Default)
  TITLE+=date
  DEPENDS+= +libpthread +libopenssl
endef

define Package/ntpdate/description
$(call Package/ntpd/Default/description)
 .
 This package contains ntpdate.
endef

define Package/ntp-utils
$(call Package/ntpd/Default)
  TITLE+= utilities
  DEPENDS+= +libpthread +libopenssl
endef

define Package/ntp-utils/description
$(call Package/ntpd/Default/description)
 .
 This package contains ntpdc, ntpq and ntptime.
endef

define Package/ntp-keygen
$(call Package/ntpd/Default)
  TITLE+=keygen
  DEPENDS+= +libopenssl +libpthread
endef

define Package/ntp-keygen/description
$(call Package/ntpd/Default/description)
 .
 This package contains the ntp-keygen.
endef

define Package/ntpd/conffiles
/etc/ntp.conf
endef

CONFIGURE_VARS += \
	ac_cv_header_md5_h=no \
	ac_cv_lib_rt_sched_setscheduler=no \
	ac_cv_header_dns_sd_h=no

CONFIGURE_ARGS += \
	--disable-all-clocks \
	--disable-parse-clocks \
	--without-ntpsnmpd \
	--without-lineeditlibs \
	--enable-NMEA \
	--enable-LOCAL-CLOCK \
	--enable-SHM \
	--enable-linuxcaps \
	--with-yielding-select=yes \
	--with-crypto \
	--with-openssl-incdir="$(STAGING_DIR)/usr/include" \
	--with-openssl-libdir="$(STAGING_DIR)/usr/lib"

define Package/ntpd/install
	$(INSTALL_DIR) $(1)/sbin
	$(INSTALL_BIN) $(PKG_BUILD_DIR)/ntpd/ntpd $(1)/sbin/
	$(INSTALL_DIR) $(1)/etc
	$(INSTALL_CONF) ./files/ntp.conf $(1)/etc/
	$(INSTALL_DIR) $(1)/etc/init.d
	$(INSTALL_BIN) ./files/ntpd.init $(1)/etc/init.d/ntpd
	$(INSTALL_DIR) $(1)/etc/hotplug.d/iface
	$(INSTALL_BIN) ./files/ntpd.hotplug $(1)/etc/hotplug.d/iface/20-ntpd
endef

define Package/ntpd/postinst
#!/bin/sh
[ -L "$${IPKG_INSTROOT}/usr/sbin/ntpd" ] && rm -f "$${IPKG_INSTROOT}/usr/sbin/ntpd"
exit 0
endef

define Package/ntpd/postrm
#!/bin/sh
/bin/busybox ntpd -h 2>&1 | grep -q BusyBox && ln -sf ../../bin/busybox /usr/sbin/ntpd
exit 0
endef

define Package/ntpdate/install
	$(INSTALL_DIR) $(1)/usr/sbin
	$(INSTALL_BIN) $(PKG_BUILD_DIR)/ntpdate/ntpdate $(1)/usr/sbin/
	$(INSTALL_DIR) $(1)/etc/init.d
	$(INSTALL_BIN) ./files/ntpdate.init $(1)/etc/init.d/ntpdate
endef

define Package/ntp-utils/install
	$(INSTALL_DIR) $(1)/usr/sbin
	$(INSTALL_BIN) $(PKG_BUILD_DIR)/ntpdc/ntpdc $(1)/usr/sbin/
	$(INSTALL_BIN) $(PKG_BUILD_DIR)/ntpq/ntpq $(1)/usr/sbin/
	$(INSTALL_BIN) $(PKG_BUILD_DIR)/util/ntptime $(1)/usr/sbin/
endef

define Package/ntp-keygen/install
	$(INSTALL_DIR) $(1)/usr/sbin
	$(INSTALL_BIN) $(PKG_BUILD_DIR)/util/ntp-keygen $(1)/usr/sbin/
endef

$(eval $(call BuildPackage,ntpd))
$(eval $(call BuildPackage,ntpdate))
$(eval $(call BuildPackage,ntp-utils))
$(eval $(call BuildPackage,ntp-keygen))


然後重新編譯，我TM重編第三次了
$ cd ~/openwrt/trunk
$ make clean
$ make V=s

＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊
Openwrt 的FTP上面有些檔案不知道為什麼抓不下來，還是消失了
所以在
~/openwrt/trunk/dl
目錄裡面
有很多.tar.gz要手動下載



＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊

